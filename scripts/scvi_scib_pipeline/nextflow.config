
// workflow marapeters
params {
    // process params
    output_dir               = "results"
    publish_mode             = 'copy'

    // Main pipeline parameters
    sample_id = 'subset_100k'
    adata     = '/lustre/scratch127/cellgen/cellgeni/tickets/tic-4101/data/subset_100k_processed.h5ad'
      // scVI parameters
    batch_key  = ['concatenated_integration_covariates']
    n_hidden   = [512, 1024]
    n_latent   = [26]
    n_layers   = [2, 3]
    dropout    = [0.1]
    lr         = [0.0001]
    batch_size = [128]
    likelihood = ['nb']
    n_epochs   = [5]
    layer      = ""
      // scIB parameters
    celltype_key = 'cell_type_lvl3'
    fraction     = 0.9
    lognorm    = true
    n_pca = 50
    hvg   = false
}

process {
    queue         = 'normal'
    maxRetries    = 5
    errorStrategy = "retry"
    container     = '/nfs/cellgeni/singularity/images/scenicplus-fa55dae.sif'

    withName:scVI {
        ext.args            = {
            [
                params.layer ? "--layer ${params.layer}" : "",
            ].join(" ")
        }
        memory              = { 30.GB * task.attempt }
        queue               = 'gpu-cellgen-restricted'
        clusterOptions      = ' -gpu "mode=shared:j_exclusive=no:gmem=6000:num=1"'
        containerOptions    = '--nv'
        publishDir          = [
            path: { "${params.output_dir}/scvi" },
            mode: "${params.publish_mode}",
        ]
    }
    withName:downsampleAdata {
        ext.args            = {
            [
                params.celltype_key ? "--celltype_key ${params.celltype_key}": "",
                params.fraction     ? "--fraction ${params.fraction}"        : "",
                params.lognorm ? "--lognorm"              : "",
                params.hvg     ? "--hvg"                  : "",
                params.n_pca   ? "--n_pca ${params.n_pca}": ""
            ].join(" ")
        }
        memory              = { 30.GB * task.attempt }
        queue               = 'normal'
        publishDir          = [
            path: { "${params.output_dir}/downsample" },
            mode: "${params.publish_mode}",
        ]
    }
    withName:scIB_plot {
        memory              = { 12.GB * task.attempt }
        queue               = 'normal'
        publishDir          = [
            path: { "${params.output_dir}" },
            mode: "${params.publish_mode}",
        ]
    }
    withName:collect_versions {
        memory = { 2.GB * task.attempt }
        queue  = 'normal'
        publishDir = [
            path: { "${params.output_dir}" },
            mode: "${params.publish_mode}",
        ]
    }
    // withName:downsample_adata {
    //     ext.args            = {
    //         [
    //             params.celltype_key ? "--celltype_key ${params.celltype_key}": "",
    //             params.fraction     ? "--fraction ${params.fraction}"        : ""
    //         ].join(" ")
    //     }
    //     memory              = { 30.GB * task.attempt }
    //     queue               = 'normal'
    //     publishDir          = [
    //         path: { "${params.output_dir}" },
    //         mode: "${params.publish_mode}",
    //     ]
    // }
    // withName:preprocess_pca {
    //     ext.args            = {
    //         [
    //             params.lognorm ? "--lognorm"              : "",
    //             params.hvg     ? "--hvg"                  : "",
    //             params.n_pca   ? "--n_pca ${params.n_pca}": ""

    //         ].join(" ")
    //     }
    //     memory              = { 30.GB * task.attempt }
    //     queue               = 'normal'
    //     publishDir          = [
    //         path: { "${params.output_dir}" },
    //         mode: "${params.publish_mode}",
    //     ]
    // }
    withName:scIB {
        ext.args            = {
            [
                params.celltype_key ? "--celltype_key ${params.celltype_key}" : "",
                params.batch_key    ? "--batch_key ${params.batch_key.join(',')}" : ""
            ].join(" ")
        }
        memory              = { 30.GB * task.attempt }
        queue               = 'normal'
        publishDir          = [
            path: { "${params.output_dir}/benchmark" },
            mode: "${params.publish_mode}",
        ]
    }   
}

singularity {
    enabled    = true
    autoMounts = true
    runOptions = '-B /lustre,/nfs'
    cacheDir   = '/nfs/cellgeni/singularity/images/'
}

executor {
    name           = 'lsf'
    perJobMemLimit = true
}

// Capturing Nextflow log files into a 'reports' directory
import java.time.*
Date now = new Date()

params {
    tracedir  = "reports"
    timestamp = now.format("yyyyMMdd-HH-mm-ss")
}

timeline {
    enabled = true
    file    = "${params.tracedir}/${params.timestamp}_timeline.html"
}

report {
    enabled = true
    file    = "${params.tracedir}/${params.timestamp}_report.html"
}

trace {
    enabled = true
    file    = "${params.tracedir}/${params.timestamp}_trace.tsv"
}

// Unscoped options
outputDir = params.output_dir
cleanup   = false
workDir   = "nf-work"